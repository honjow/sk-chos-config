#!/bin/bash

VENDOR=$(cat /sys/devices/virtual/dmi/id/sys_vendor)

echo "Auto set shell"
/usr/bin/sk-auto-set-shell

echo "reset Internal screen"
sed -i '/Internal screen/d' "${HOME}/.config/gamescope/modes.cfg"

# check gpdconfig is installed
if [[ -f /usr/bin/gpdconfig && "$VENDOR" == "GPD" ]]; then
    gpdconfig l41=SYSRQ r41=PAUSE
fi

# pacman -Q , check install gnome-shell-extension-screen-autorotate
if [[ $(pacman -Q | grep gnome-shell-extension-screen-autorotate) ]]; then
    echo "gnome-shell-extension-screen-autorotate is installed, set orientation-offset..."
    # check gsettings is installed
    if [[ -f /usr/bin/gsettings ]]; then
        if [[ -f /etc/sk-chos/screen-rotate ]]; then
            source /etc/sk-chos/screen-rotate
            gsettings set org.gnome.shell.extensions.screen-rotate orientation-offset "${ROTATE_OFFSET}"
        fi
    fi
fi

# install pre download oh-my-zsh
pre_path=/usr/local/share/sk-pre
zsh_path=$pre_path/zsh
pre_zsh_dir=$pre_path/zsh/ohmyzsh
pre_zshrc=$pre_path/zsh/.zshrc

if [[ -d $pre_zsh_dir ]]; then
    if [[ ! -d "${HOME}/.oh-my-zsh" ]]; then
        echo "Installing oh-my-zsh..."
        cp -r $pre_zsh_dir "${HOME}/.oh-my-zsh"
    fi
fi

if [[ -f $pre_zshrc ]]; then
    if [[ ! -f "${HOME}/.zshrc" ]]; then
        echo "Installing .zshrc..."
        cp $pre_zshrc "${HOME}/.zshrc"
    else
        cp $pre_zshrc "${HOME}/.zshrc.new"
    fi
fi


# after update run
after_update_flag=/.after-update
if [[ ! -f $after_update_flag ]]; then
    echo "after update run first-run..."
    /usr/bin/sk-first-run
    sudo touch $after_update_flag
fi

# 如果安装了kde桌面, 根据 $HOME/.config/plasma-localerc 更新 locale.conf
if pacman -Q | grep -q plasma-desktop; then
    if [[ -f $HOME/.config/plasma-localerc ]]; then
        # 读取 plasma-localerc 中 LANG= 的值
        LANG=$(grep LANG= $HOME/.config/plasma-localerc | cut -d= -f2)
        ORIG_LANG=$LANG
        # 去掉.后面的内容
        LANG=${LANG%%.*}

        if [[ "${ORIG_LANG}" != "${LANG}.UTF-8" ]]; then
            echo "update plasma-localerc LANG=${LANG}.UTF-8"
            sed -i "s/LANG=.*/LANG=${LANG}.UTF-8/" $HOME/.config/plasma-localerc
        fi

        # 读取 /etc/locale.conf 中 LANG= 的值
        E_LANG=$(grep LANG= /etc/locale.conf | cut -d= -f2)
        if [[ "${E_LANG}" != "${LANG}.UTF-8" ]]; then
            echo "update locale.conf LANG=${LANG}.UTF-8"
            echo "LANG=${LANG}.UTF-8" | sudo tee /etc/locale.conf
            sudo locale-gen
        fi
    fi
fi
